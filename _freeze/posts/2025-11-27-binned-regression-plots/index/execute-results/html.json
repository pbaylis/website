{
  "hash": "ffd119bdc58cd829354a20c0a029bedf",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Plotting binned regression estimates in R\"\ndescription: \"A quick guide to extracting and plotting coefficient estimates from binned regressions using fixest\"\nauthor: \"Patrick Baylis\"\ndate: 2025-11-27\nformat: \n  html:\n    page-layout: full\ncategories:\n  - R\n  - visualization\n---\n\nI work a lot with binned regressions, i.e., regressions that estimate the effect of a variable that has been discretized into bins. This is common in applied microeconomics, where researchers often want to estimate the effect of a continuous variable (e.g., temperature, income, distance) on an outcome while allowing for nonlinearities by binning the variable. The canonical estimating equation here is something like:\n\n$$y_i = \\sum_{b=1}^{B} \\beta_b \\text{1}[x_i \\in \\text{bin } b] + \\varepsilon_i$$\n\nwhere $y_i$ is the outcome, $x_i$ is the continuous independent variable that has been binned into $B$ bins, and $\\varepsilon_i$ is the error term.\n\nAnyway, I've found myself writing the same code over and over to estimate models using a binned independent variable and then to plot those estimates. To save my future self some time, this post documents a general workflow for estimating, extracting, and plotting coefficient estimates from binned models.\n\n## Setup\n\nWe'll use the excellent [`fixest`](https://lrberge.github.io/fixest/) for estimation and the `tidyverse` for data manipulation and plotting.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(tidyverse, fixest, cowplot)\ntheme_set(theme_cowplot())\nset.seed(42)\n```\n:::\n\n\n## Generate fake data\n\nLet's create some fake data where the outcome has a nonlinear relationship with temperature. I'll generate data that shows \"performance\" (e.g., productivity or athletic performance) declining at high temperatures.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn <- 500\n\ndata <- tibble(\n  id = 1:n,\n  group = sample(LETTERS[1:10], n, replace = TRUE),\n  temperature = rnorm(n, mean = 20, sd = 10),\n  noise = rnorm(n, 0, 3)\n) %>%\n  mutate(\n    # Create a nonlinear effect: small effect until temp > 15, then larger negative effect\n    performance = 100 - 0.1 * pmax(temperature - 15, 0)^1.5 + noise,\n    # Bin the temperature variable\n    temp_bin = cut(temperature, breaks = c(-Inf, seq(0, 40, 5), Inf))\n  )\n\nglimpse(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 500\nColumns: 6\n$ id          <int> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17,…\n$ group       <chr> \"A\", \"E\", \"A\", \"I\", \"J\", \"D\", \"B\", \"J\", \"A\", \"H\", \"G\", \"D\"…\n$ temperature <dbl> 24.0143625, 4.9065749, 8.6163413, 23.3774120, 5.2737186, 1…\n$ noise       <dbl> -4.2756753, -1.4613355, -0.8006003, 0.6995681, -1.2175681,…\n$ performance <dbl> 93.01786, 98.53866, 99.19940, 98.27483, 98.78243, 101.8180…\n$ temp_bin    <fct> \"(20,25]\", \"(0,5]\", \"(5,10]\", \"(20,25]\", \"(5,10]\", \"(15,20…\n```\n\n\n:::\n:::\n\n\n## Estimate the model\n\nWe'll estimate a simple model with binned temperature and group fixed effects. The reference category is the bin containing temperatures around 15-20°C (where we expect performance to be close to baseline).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit <- feols(performance ~ i(temp_bin, ref = \"(15,20]\") | group, data = data)\n\netable(fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                                           fit\nDependent Var.:                    performance\n                                              \ntemp_bin = (-Inf,0]15,20]\")    0.5785 (0.8412)\ntemp_bin = (0,5]15,20]\")       0.4285 (0.6700)\ntemp_bin = (5,10]15,20]\")      0.1270 (0.5590)\ntemp_bin = (10,15]15,20]\")    0.8427. (0.5032)\ntemp_bin = (20,25]15,20]\")  -2.253*** (0.4723)\ntemp_bin = (25,30]15,20]\")  -4.087*** (0.5074)\ntemp_bin = (30,35]15,20]\")  -6.915*** (0.5860)\ntemp_bin = (35,40]15,20]\")  -10.46*** (0.7569)\ntemp_bin = (40,Inf]15,20]\") -15.00*** (0.9396)\nFixed-Effects:              ------------------\ngroup                                      Yes\n___________________________ __________________\nS.E. type                                  IID\nObservations                               500\nR2                                     0.58630\nWithin R2                              0.57832\n---\nSignif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n## Extract and clean coefficients\n\nNow we can extract the coefficients. We do that by saving the output of `coefplot`, which gives us a tidy data frame of estimates in the `prms` object. Note that calling `coefplot` yields a pretty good plot by default! So you may want to stop here if you're just doing a quick visualization.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get coefficient estimates with confidence intervals\ncoef_df <- coefplot(fit, keep = \"temp_bin\")$prms\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/extract-coefs-1.png){width=672}\n:::\n:::\n\n\nAssuming we do want to customize the plot further, we can now extract the bin limits and calculate midpoints for plotting. I wrote a helper function that parses the bin names and extracts the lower and upper bounds. It also (optionally) corrects infinite bounds to finite values based on the bin width.\n\nFinally, the body of the code itself also includes the addition of the reference category (which has an estimate of 0 by definition) and arranges the data frame by bin midpoints.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nextract_limits_from_bin_names <- function(x, fix_Inf = TRUE) {\n  # Extract intervals from coefficient names like \"temp_bin::(0,5]\"\n  intervals_chr <- str_extract(x, \"\\\\(([^,]+),([^\\\\]]+)\\\\]\")\n  \n  # Parse the lower and upper bounds\n  intervals <- str_match(intervals_chr, \"\\\\(([^,]+),([^\\\\]]+)\\\\]\")\n  \n  intervals_df <- data.frame(\n    bin_low = as.numeric(intervals[, 2]),\n    bin_high = as.numeric(intervals[, 3])\n  )\n  \n  # Replace infinite bounds with finite values based on bin width\n  if (fix_Inf) {\n    bin_size <- intervals_df$bin_high - intervals_df$bin_low\n    bin_size <- min(bin_size[is.finite(bin_size)])\n    \n    intervals_df <- intervals_df %>%\n      mutate(\n        bin_low = if_else(is.infinite(bin_low), bin_high - bin_size, bin_low),\n        bin_high = if_else(is.infinite(bin_high), bin_low + bin_size, bin_high)\n      )\n  }\n  \n  return(intervals_df)\n}\n\n# Extract bin limits and calculate midpoints\ncoef_df <- coef_df %>%\n  bind_cols(extract_limits_from_bin_names(coef_df$estimate_names)) %>%\n  mutate(bin_mid = (bin_low + bin_high) / 2)\n\n# Add the reference category (estimate = 0)\nref_df <- tibble(\n  estimate_names = \"(15,20]\",\n  estimate = 0,\n  ci_low = 0,\n  ci_high = 0,\n  bin_low = 15,\n  bin_high = 20,\n  bin_mid = 17.5\n)\n\ncoef_df <- bind_rows(coef_df, ref_df) %>%\n  arrange(bin_mid)\n\nglimpse(coef_df)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 10\nColumns: 11\n$ estimate           <dbl> 0.5785088, 0.4284605, 0.1269886, 0.8427303, 0.00000…\n$ ci_low             <dbl> -1.0742853, -0.8879347, -0.9714904, -0.1460390, 0.0…\n$ ci_high            <dbl> 2.231303, 1.744856, 1.225468, 1.831500, 0.000000, -…\n$ estimate_names     <chr> \"temp_bin::(-Inf,0]15,20]\\\")\", \"temp_bin::(0,5]15,2…\n$ estimate_names_raw <chr> \"temp_bin::(-Inf,0]15,20]\\\")\", \"temp_bin::(0,5]15,2…\n$ id                 <dbl> 1, 1, 1, 1, NA, 1, 1, 1, 1, 1\n$ x                  <dbl> 1, 2, 3, 4, NA, 5, 6, 7, 8, 9\n$ y                  <dbl> 0.5785088, 0.4284605, 0.1269886, 0.8427303, NA, -2.…\n$ bin_low            <dbl> -5, 0, 5, 10, 15, 20, 25, 30, 35, 40\n$ bin_high           <dbl> 0, 5, 10, 15, 20, 25, 30, 35, 40, 45\n$ bin_mid            <dbl> -2.5, 2.5, 7.5, 12.5, 17.5, 22.5, 27.5, 32.5, 37.5,…\n```\n\n\n:::\n:::\n\n\n## Plot the results\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(coef_df, aes(x = bin_mid, y = estimate)) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"gray50\") +\n  geom_ribbon(aes(ymin = ci_low, ymax = ci_high), alpha = 0.2, fill = \"steelblue\") +\n  geom_line(color = \"steelblue\", linewidth = 1) +\n  geom_point(color = \"steelblue\", size = 2) +\n  labs(\n    x = \"Temperature (°C)\",\n    y = \"Change in performance relative to 15-20°C\",\n    title = \"Effect of temperature on performance\"\n  ) +\n  theme_cowplot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-estimates-1.png){width=768}\n:::\n:::\n\n\nThe plot clearly shows the nonlinear effect we built into the data: performance is relatively stable at cooler temperatures but declines sharply once temperatures exceed about 20°C.\n\n## Wrapping up\n\nThis workflow is handy whenever you're working with binned variables and want to visualize the estimates. The key steps are:\n\n1. Create bins using `cut()`\n2. Estimate the model with `i()` syntax in `fixest`\n3. Extract coefficients using `coefplot()`\n4. Parse bin limits from coefficient names\n5. Add the reference category manually\n6. Plot using `ggplot2`\n\nThe `extract_limits_from_bin_names()` function does the heavy lifting of parsing the interval notation, which saves you from manually typing out bin midpoints or limits.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}