{
  "hash": "309487e8a4505538a39345b236ae75ba",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Response functions with fixed effects\"\ndescription: \"Using fixest + marginaleffects to plot response functions with fixed effects\"\nauthor: \"Patrick Baylis\"\ndate: 2025-09-25\nbibliography: \"refs.bib\"\ndraft: false\nformat: \n  html:\n    page-layout: full\ncategories:\n  - R\n  - econometrics\n---\n\nIn a [2021 post](/posts/2021-01-22-predict-partial/), I shared code for plotting **response functions** from models with high-dimensional fixed effects (like those produced by [fixest](https://lrberge.github.io/fixest/)). This approach is useful when we want to show how an outcome changes with respect to temperature. I’m happy to report that that code is now basically obsolete thanks to the [marginaleffects](https://github.com/vincentarelbundock/marginaleffects) package. This post shows how to plot such functions.\n\n### A review of response functions\n\nTemperature affects a lot of stuff. Researchers working in climate impacts often want to examine how an outcome is affected by temperature. For example, a relationship of significant interest to our literature is the link between temperature and mortality (see, for example, @carleton2022valuing). The thing is, there's a lot of good medical reasons to think that the effect might be **nonlinear**, such as that mortality might be higher when it's cold or hot than when the temperature is moderate. Finally, we might want to control for correlations between the outcome and climate that aren't actually a result of the temperature, such as that Miami might just have higher mortality rates than Minnesota for reasons that aren't directly due to recent temperature fluctuations. \n\nIn econometric-speak, a generic form of a model we could use to investigate this relationship (using only unit fixed effects for brevity) is:\n\n$$y_{it} = f(T; \\beta) + \\phi_i + \\varepsilon_{it}$$\n\nwhere $y_{it}$ is the outcome of interest (e.g., log mortality), $f(T; \\beta)$ is a flexible function of temperature (e.g., polynomial, splines), $\\phi_i$ are unit fixed effects, and $\\varepsilon_{it}$ is an error term.\n\nOur task is to reproduce an estimate of $f(T; \\beta)$ that, holding everything else equal, shows how the outcome changes with temperature *relative to some baseline temperature*. In short, we want to **compare the predicted value of the outcome $y$ at a range of plausible values for $x$ to its predicted value at a reference level of $x$**. \n\nNote that I previously called these \"partial predictions\", but I don't think that's universally agreed on terminology so I'll call them \"comparisons\" here, since that's what the `marginaleffects` package calls them. We also want to get a sense of our certainty around that estimate—that is, a confidence interval. That’s what I wrote a bunch of code to do back in 2021, but now `marginaleffects::comparisons()` can do it for us.\n\n### Simulation\n\nI’ll follow the previous post and simulate some panel data with a nonlinear relationship between temperature and an outcome.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(tidyverse, marginaleffects, fixest, cowplot)\n\n# DGP\nset.seed(42)\nN <- 100\ndata <- data.frame(x = rnorm(N), id = rep(c(\"A\", \"B\"), times = N/2))\ndata$y <- 1 + 3 * data$x - 2 * data$x^2 + as.numeric(data$id == \"A\") * 3 + rnorm(N, 0, 10) \n\n# Fit a model that accounts for group means\nfit_feols <- feols(y ~ x + I(x^2) | id, data = data)\netable(fit_feols)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                        fit_feols\nDependent Var.:                 y\n                                 \nx               3.322*** (0.9207)\nI(I(x^2))       -1.888** (0.6076)\nFixed-Effects:  -----------------\nid                            Yes\n_______________ _________________\nS.E. type                     IID\nObservations                  100\nR2                        0.24974\nWithin R2                 0.24735\n---\nSignif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n### Plot the response function\n\nNow we want to plot the response function using the `comparisons()` function from the `marginaleffects` package. We create some fake data (which needs to include *all* the variables in the model, though only `x` needs to vary). The function doesn’t behave exactly as one might expect, but with a little [help](https://stackoverflow.com/questions/79782144/r-marginaleffectscomparisons-not-generating-expected-outputs/79782164#79782164) from a fellow UBC researcher on Stack Overflow, I worked out how to make it do what I needed.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nx_ref <- 1 # reference x value\nx_pred <- seq(-3, 3, 0.1) # x values we want to compare to our reference\n\n# Construct variables we need to pass to comparisons()\ncomps <- data.frame(hi = x_ref, lo = x_pred)\n\npred_df <- comparisons(fit_feols, \n                       variables = list(\"x\" = comps), \n                       newdata = datagrid(x = x_pred))\npred_df$x <- x_pred\n\n# Plot\nggplot(pred_df, aes(x = x, y = estimate)) +\n  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = \"lightblue\") +\n  geom_line() + \n  theme_cowplot()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 1 row containing missing values or values outside the scale range\n(`geom_ribbon()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-response-1.png){width=672}\n:::\n:::\n\n\nAnd that’s it! Well, almost. I don’t want to remember the fancy footwork above every time, so I include a small helper function that packages it all up in a somewhat generic form.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_comparisons <- function(model, varname, x_vals, x_ref) {\n  comps <- data.frame(hi = x_ref, lo = x_vals)\n  \n  variables_list <- list(comps)\n  names(variables_list) <- varname\n  \n  pred_df <- comparisons(fit_feols, \n                         variables = variables_list, \n                         newdata = datagrid(x = x_vals))\n  pred_df$x <- comps$lo\n  \n  return(pred_df)\n}\n\n# Using the function, compare over a smaller range with a different reference x\npred_df2 <- get_comparisons(fit_feols, \"x\", x_vals = seq(-2, 2, 0.01), x_ref = -1)\n\n# Plot again\nggplot(pred_df2, aes(x = x, y = estimate)) +\n  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = \"red\", alpha = 0.5) +\n  geom_line() + \n  theme_cowplot()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 1 row containing missing values or values outside the scale range\n(`geom_ribbon()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-w-function-1.png){width=672}\n:::\n:::\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}