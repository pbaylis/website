{
  "hash": "bd63edbe2a1045b65e045c4cc6b1da11",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"This map is on fire\"\ndescription: \"Visualizing how well Wildfire Hazard Potential maps predict actual wildfires using sf and raster in R\"\nauthor: \"Patrick Baylis\"\ndate: 2021-01-31\nformat: \n  html:\n    page-layout: full\ncategories:\n  - wildfire\n  - maps\n  - R\n---\n\n::: {.callout-note}\n# Updates\n\n- Updated 2025-11-24 to reload WHP 2023 data and fix broken links. (Note that this actually changes the visual relationship between WHP and historical fires somewhat, since the 2023 data reflects more recent landscape changes.)\n:::\n\nI like making maps and thinking about wildfires. For a recent [project](https://www.nber.org/system/files/working_papers/w26550/w26550.pdf) examining the implicit subsidy of wildfire suppression (joint with the inimitable [Judson Boomhower](https://www.judsonboomhower.com/)), we used Wildfire Hazard Potential (WHP for short) [maps](https://www.firelab.org/project/wildfire-hazard-potential) from the U.S. Forest Service as a measure how likely various areas were to catch on fire.\n\nToday, I got to thinking: how much do these WHP maps predict actual wildfire? And, can I make some maps to help visualize this? I should say here that I am guilty of loving maps, possibly too much, and one of my favorite packages in R is [`sf`](https://github.com/r-spatial/sf/), which has --- in my view --- absolutely revolutionized spatial analysis in R. I don't think enough people know just how __easy__ `sf` makes this kind of mapping. Let's dig in.\n\nFirst, some preliminaries: load `sf` and a number of other helper packages. Using the `raster` package, I load the WHP raster downloaded from the link above. (Note: to run this code yourself, you'll need to download the relevant files and put them in a directory where the code can access them.)\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(tidyverse, sf, cowplot, raster, scales, tigris)\n\n# Set some knitr options\nknitr::opts_knit$set(message = F, warning = F)\n\n# Load WHP raster (270m that covers the entire U.S., there is also a 30m version that is split up by state but those files are much larger)\n# Source: https://www.fs.usda.gov/rds/archive/catalog/RDS-2015-0047-4\nwhp <- raster(\"~/Downloads/Data/whp2023_GeoTIF/whp2023_cnt_conus.tif\")\n```\n:::\n\n\n## Butte County, CA\n\nFor this \"analysis\", I'm going to focus on Butte County, which is a bit north of Sacramento in northern California and contains a number of small towns that have, sadly, [been hard-hit](https://www.sfchronicle.com/california-wildfires/article/At-Station-62-shelter-from-the-firestorm-15576500.php) by wildfire in the last few decades. The most recent example of this was the devastating 2018 Camp Fire. To focus on Butte, I load a county [shapefile](https://catalog.data.gov/dataset/2015-cartographic-boundary-file-state-county-for-united-states-1-20000000) --- notice how easy `sf` makes it to quickly filter to Butte and to reproject to match the WHP raster. It also interfaces very well with `ggplot2`, part of the [`tidyverse`](https://www.tidyverse.org/) that we loaded earlier.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbutte <- counties(state = \"CA\", year = 2019, cb = TRUE, progress_bar = FALSE) %>%\n  filter(GEOID == \"06007\") %>%\n  st_transform(proj4string(whp))\n\nggplot(butte) + geom_sf()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/butte-1.png){width=672}\n:::\n:::\n\n\n## Wildfire Hazard Potential in Butte\n\nThe next step is to crop the WHP raster to Butte. This, too, is easy, since `raster` now plays nicely with `sf`. We can then plot the result.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwhp <- crop(whp, butte)\nplot(whp)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/crop-whp-1.png){width=672}\n:::\n:::\n\n\nBut, we'd rather do our raster plotting using ggplot. This is easy as well --- we simply convert the raster to a `data.frame` (often called \"fortifying\" the raster) and add it to our original Butte County plot.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwhp_df <- as.data.frame(whp, xy=TRUE)\n\nggplot(butte) + \n  geom_raster(data = whp_df, mapping = aes(x = x, y = y, fill = Band_1)) + \n  geom_sf(fill = NA) + \n  scale_fill_distiller(palette = \"YlOrRd\", direction = 1) + \n  guides(fill = \"none\") + \n  theme_map()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-whp-1.png){width=672}\n:::\n:::\n\n\n## History of wildfires in Butte County\n\nThe next step is to see where wildfires have occurred and re-occurred in Butte over the years. To do this, we'll load another data source: historic [fire perimeters](https://frap.fire.ca.gov/frap-projects/fire-perimeters/) from CAL FIRE. This history runs all the way back to 1878 until the present day, although data sparsity varies over that time period. Still, we should be able to use it to get a rough sense for where, historically, fires have occurred. We'll load the perimeters and, like the WHP raster, crop them to Butte County.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Source: https://www.fire.ca.gov/what-we-do/fire-resource-assessment-program/fire-perimeters\nperims <- st_read(\"~/Downloads/fire24_1.gdb/\", layer = \"firep24_1\")\n\nperims_butte <- perims %>% \n  st_cast(\"MULTIPOLYGON\") %>% # Avoid Unknown WKB type 12 error\n  st_make_valid() %>% # Fixes other possible errors\n  st_transform(st_crs(butte)) %>% \n  st_crop(butte)\n```\n:::\n\n\nYou'll see that there are a few more lines of code before we crop. Sometimes shapefiles will have one error or another that need to be resolved before we can do operations like cropping. In this case, there are two issues: one is that there's a funny polygon type in the original shapefile, and two is that a small number of these polygons are invalid. Without going deep into these issues, we fix the first by \"casting\" the funny polygon to a multi-polygon type that `sf` knows how to handle, and the second by using a function to patch invalid polygons. Once we've done that, we can again reproject to match our other spatial objects and crop to Butte.\n\nThe next step is to count the number of overlapping fire areas in the county. Here we'll use a neat (and frankly not very well-documented) trick: `st_intersection`, an `sf` function, can figure out where polygons overlap and how many of them overlap in each place. This is a little time-consuming, but once it's done we can sort the overlaps by their number (from least to most) and plot with `ggplot`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nperims_butte_overlaps <- st_intersection(perims_butte) %>% \n  arrange(n.overlaps)\n\nggplot(butte) + \n  geom_sf(data = perims_butte_overlaps, aes(fill = n.overlaps)) + \n  geom_sf(fill = NA) + \n  scale_fill_distiller(name = \"Number of fires\", palette = \"YlOrRd\", direction = 1) + \n  theme_map()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/count-overlaps-1.png){width=672}\n:::\n:::\n\n\nThere's a couple things to note here. First, even historically, fire does not strike the same areas many times over. This is likely because once an area has burned in a significant way, it takes a number of years before there's enough fuel built back up that it can burn again. The second is that, visually speaking, the historical pattern of fires doesn't look all that similar to the wildfire hazard potential map. But we can go another step further here to see this a bit more clearly: we can combine the two maps.\n\nTo combine the two maps, we have to decide which one to plot with color and which to plot some other way. In this case, I've chosen to stick with the original coloring for WHP and use transparency to represent the number of fires in each area. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(butte) + \n  geom_raster(data = whp_df, mapping = aes(x = x, y = y, fill = Band_1)) + \n  geom_sf(data = perims_butte, fill = \"black\", colour = NA, alpha = 0.25) + \n  geom_sf(fill = NA) + \n  scale_fill_distiller(palette = \"PuBuGn\", direction = 1) + \n  guides(fill = FALSE) + \n  theme_map()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: The `<scale>` argument of `guides()` cannot be `FALSE`. Use \"none\" instead as\nof ggplot2 3.3.4.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot-both-1.png){width=672}\n:::\n:::\n\n\nYou can see that, in Butte County at least, there isn't much of a relationship between hazard potential and actual historical fire. Some low hazard potential areas have been hit by fires many times over, and some high potential areas have never been hit. But this is very likely mixing up cause and effect: the WHP (wildfire potential) map is built with landscape characteristics that reflect 2020 conditions, so only a couple of years after the devastating Camp Fire. Areas that have burned recently are likely to have lower hazard potential because there's less fuel to burn. To really assess how well WHP predicts fire, we'd need to look at how well it predicted fire before the map was made. A project for another day.\n\nThat's it for now. Hopefully this has given you a sense for some of the capability --- and relative simplicity! --- of spatial work in R. Happy mapping!",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}